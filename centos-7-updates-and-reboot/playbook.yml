####################################################################
#Tasklist: CentOS 7 Update automation
#Description: Updates CentOS 7 nodes and reboots them (if needed) using ansible
#Author: Peter Potvin
#Email: (REDACTED)
#Revision 1 - 8 May 2021
###################################################################
- hosts: centos-7
  gather_facts: true
  become: true
  vars_files:
    - vars/default.yml

  tasks:
  # Upgrade system packages
    - name: upgrade packages via yum
      yum:
        name: "{{ yum_name }}"
        state: "{{ yum_state }}"
      register: yumcommandout
      when:
        - (ansible_facts['distribution_major_version'] == '7')

    - name: Print errors if yum failed
      debug:
        msg: "yum command produced errors"
      when: yumcommandout is not defined

    - name: Check if a reboot is needed on all servers
      register: reboot_required_file
      stat: path=/var/run/reboot-required get_md5=no

    - name: Reboot the box if kernel updated
      reboot:
        msg: "Reboot initiated by Ansible for kernel updates"
        connect_timeout: 5
        reboot_timeout: 150
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime
      when: reboot_required_file.stat.exists